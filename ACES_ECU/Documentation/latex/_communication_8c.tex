\hypertarget{_communication_8c}{}\section{C\+:/\+Users/nickm/\+Documents/\+Git\+Hub/\+A\+C\+E\+S\+\_\+\+E\+C\+U/\+A\+C\+E\+S\+\_\+\+E\+C\+U/\+Communication.c File Reference}
\label{_communication_8c}\index{C\+:/\+Users/nickm/\+Documents/\+Git\+Hub/\+A\+C\+E\+S\+\_\+\+E\+C\+U/\+A\+C\+E\+S\+\_\+\+E\+C\+U/\+Communication.\+c@{C\+:/\+Users/nickm/\+Documents/\+Git\+Hub/\+A\+C\+E\+S\+\_\+\+E\+C\+U/\+A\+C\+E\+S\+\_\+\+E\+C\+U/\+Communication.\+c}}


Implementation for the functions relating to the communication of the E\+C\+U/\+E\+SB and E\+C\+U/\+Windows G\+UI.  


{\ttfamily \#include $<$avr/io.\+h$>$}\newline
{\ttfamily \#include $<$avr/interrupt.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include \char`\"{}E\+C\+U\+\_\+funcs.\+h\char`\"{}}\newline
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{_communication_8c_a9ad78c90a2e828201a614444385801c7}{send\+To\+E\+SB}} (uint8\+\_\+t len)
\begin{DoxyCompactList}\small\item\em Transmits data between the E\+CU and E\+SB. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{_communication_8c_aa3590f927d6f0e270aad13cd890ba3d5}{E\+S\+B\+\_\+\+Connect}} (void)
\begin{DoxyCompactList}\small\item\em Establishes the connection between the E\+CU and E\+SB. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{_communication_8c_ada467eaa29152bd3a35afbf4d62e53fd}{G\+U\+I\+\_\+\+Connect}} (void)
\begin{DoxyCompactList}\small\item\em Establishes the connection between the E\+CU and Windows G\+UI. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{_communication_8c_aebc6f692b7c3787a859445b96ab3ec5f}{send\+To\+Laptop}} (void)
\begin{DoxyCompactList}\small\item\em Transmits periodic data between the E\+CU and Windows G\+UI. \end{DoxyCompactList}\item 
\mbox{\hyperlink{_communication_8c_a084f0a9cf05b1877bd8a71a90dae7ff8}{I\+SR}} (U\+S\+A\+R\+T0\+\_\+\+R\+X\+\_\+vect)
\begin{DoxyCompactList}\small\item\em Interrupt Service Routine for when a message has been received from the Windows G\+UI. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{_communication_8c_ae6e8a8009a9ae0c59f25a496d1cf5a84}\label{_communication_8c_ae6e8a8009a9ae0c59f25a496d1cf5a84}} 
{\bfseries I\+SR} (U\+S\+A\+R\+T1\+\_\+\+R\+X\+\_\+vect)
\item 
\mbox{\Hypertarget{_communication_8c_ae173d68280445c6d2838fe28f007ebaf}\label{_communication_8c_ae173d68280445c6d2838fe28f007ebaf}} 
void {\bfseries package\+Message} (void)
\item 
void \mbox{\hyperlink{_communication_8c_a285a2f8773a070acdcea234b60cf38ca}{repeat\+Command}} (void)
\begin{DoxyCompactList}\small\item\em Requests the Windows G\+UI to repeat the last sent command. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{_communication_8c_ae11da7e638c4141fa09c2b3748f713fd}\label{_communication_8c_ae11da7e638c4141fa09c2b3748f713fd}} 
void {\bfseries i2c\+\_\+\+Start} (unsigned char address)
\item 
\mbox{\Hypertarget{_communication_8c_a7d7492476cf394bef5161e2a6503fc1e}\label{_communication_8c_a7d7492476cf394bef5161e2a6503fc1e}} 
void {\bfseries i2c\+\_\+\+Stop} (void)
\item 
\mbox{\Hypertarget{_communication_8c_ab00dbbd4d0d7c829374f726f66020bcc}\label{_communication_8c_ab00dbbd4d0d7c829374f726f66020bcc}} 
void {\bfseries i2c\+\_\+write} (unsigned char data)
\item 
\mbox{\Hypertarget{_communication_8c_a669c0357614a79b3b35ae815f6f50e82}\label{_communication_8c_a669c0357614a79b3b35ae815f6f50e82}} 
unsigned char {\bfseries i2c\+\_\+read} (unsigned char ack)
\item 
\mbox{\Hypertarget{_communication_8c_afa161ecc9fae4c6dbf5ef7063d777d1d}\label{_communication_8c_afa161ecc9fae4c6dbf5ef7063d777d1d}} 
void {\bfseries load\+E\+S\+B\+Data} (void)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Implementation for the functions relating to the communication of the E\+C\+U/\+E\+SB and E\+C\+U/\+Windows G\+UI. 

\begin{DoxyAuthor}{Author}
Nick Moore  March 16, 2018 
\end{DoxyAuthor}
\begin{DoxyRefDesc}{Bug}
\item[\mbox{\hyperlink{bug__bug000001}{Bug}}]No known bugs. \end{DoxyRefDesc}
\begin{DoxyNote}{Note}
Add notes here 
\end{DoxyNote}


\subsection{Function Documentation}
\mbox{\Hypertarget{_communication_8c_aa3590f927d6f0e270aad13cd890ba3d5}\label{_communication_8c_aa3590f927d6f0e270aad13cd890ba3d5}} 
\index{Communication.\+c@{Communication.\+c}!E\+S\+B\+\_\+\+Connect@{E\+S\+B\+\_\+\+Connect}}
\index{E\+S\+B\+\_\+\+Connect@{E\+S\+B\+\_\+\+Connect}!Communication.\+c@{Communication.\+c}}
\subsubsection{\texorpdfstring{E\+S\+B\+\_\+\+Connect()}{ESB\_Connect()}}
{\footnotesize\ttfamily void E\+S\+B\+\_\+\+Connect (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Establishes the connection between the E\+CU and E\+SB. 

This performs the following functions\+:

1) Prepares the E\+CU\textquotesingle{}s password for transmission 2) Sends the password to the E\+SB 3) Awaits the correct return password from the E\+SB 4) repeats steps 2-\/4 until the proper return password is received


\begin{DoxyParams}{Parameters}
{\em void} & \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
void 
\end{DoxyReturn}


Definition at line 53 of file Communication.\+c.



References E\+S\+Btransmit, and send\+To\+E\+S\+B().


\begin{DoxyCode}
54 \{
55 
56     \mbox{\hyperlink{_e_c_u__funcs_8h_a346573bf31cc5cb1e4a0d2d95029782a}{ESBtransmit}}[0] = \textcolor{charliteral}{'A'};
57     \mbox{\hyperlink{_e_c_u__funcs_8h_a346573bf31cc5cb1e4a0d2d95029782a}{ESBtransmit}}[1] = \textcolor{charliteral}{'C'};
58     \mbox{\hyperlink{_e_c_u__funcs_8h_a346573bf31cc5cb1e4a0d2d95029782a}{ESBtransmit}}[2] = \textcolor{charliteral}{'E'};
59     \mbox{\hyperlink{_e_c_u__funcs_8h_a346573bf31cc5cb1e4a0d2d95029782a}{ESBtransmit}}[3] = \textcolor{charliteral}{'S'};
60     \mbox{\hyperlink{_communication_8c_a9ad78c90a2e828201a614444385801c7}{sendToESB}}(4);  
61 \}
\end{DoxyCode}
\mbox{\Hypertarget{_communication_8c_ada467eaa29152bd3a35afbf4d62e53fd}\label{_communication_8c_ada467eaa29152bd3a35afbf4d62e53fd}} 
\index{Communication.\+c@{Communication.\+c}!G\+U\+I\+\_\+\+Connect@{G\+U\+I\+\_\+\+Connect}}
\index{G\+U\+I\+\_\+\+Connect@{G\+U\+I\+\_\+\+Connect}!Communication.\+c@{Communication.\+c}}
\subsubsection{\texorpdfstring{G\+U\+I\+\_\+\+Connect()}{GUI\_Connect()}}
{\footnotesize\ttfamily void G\+U\+I\+\_\+\+Connect (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Establishes the connection between the E\+CU and Windows G\+UI. 

This performs the following functions\+:

1) Prepares the E\+CU\textquotesingle{}s password for transmission 2) Sends the password to the Windows G\+UI


\begin{DoxyParams}{Parameters}
{\em void} & \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
void 
\end{DoxyReturn}


Definition at line 73 of file Communication.\+c.



References connected\+\_\+\+G\+UI, and do\+Transmit.


\begin{DoxyCode}
74 \{
75     \textcolor{keywordtype}{char} message[] = \textcolor{stringliteral}{"DALE"};
76     \textcolor{keywordflow}{for} (uint8\_t i = 0; i < 4; i++)\{                \textcolor{comment}{// This will also send the terminator}
77         \textcolor{comment}{/* Wait for empty transmit buffer */}
78         \textcolor{keywordflow}{while} ( !( UCSR0A & (1<<UDRE0)) );
79         \textcolor{comment}{/* Put data into buffer, sends the data */}
80         UDR0 = message[i];
81     \}
82     \mbox{\hyperlink{_e_c_u__funcs_8h_aaaa9e2d2909ceb75751c9dbfab30661c}{connected\_GUI}} = 1;
83     \mbox{\hyperlink{_e_c_u__funcs_8h_aa8cc3e0359b222fe83e4f0351414d5a4}{doTransmit}} = -1;
84 \}
\end{DoxyCode}
\mbox{\Hypertarget{_communication_8c_a084f0a9cf05b1877bd8a71a90dae7ff8}\label{_communication_8c_a084f0a9cf05b1877bd8a71a90dae7ff8}} 
\index{Communication.\+c@{Communication.\+c}!I\+SR@{I\+SR}}
\index{I\+SR@{I\+SR}!Communication.\+c@{Communication.\+c}}
\subsubsection{\texorpdfstring{I\+S\+R()}{ISR()}}
{\footnotesize\ttfamily I\+SR (\begin{DoxyParamCaption}\item[{U\+S\+A\+R\+T0\+\_\+\+R\+X\+\_\+vect}]{ }\end{DoxyParamCaption})}



Interrupt Service Routine for when a message has been received from the Windows G\+UI. 

This performs the following functions\+:

1) Sets the new\+Command variable based on which type of command is being received 2) Awaits the second a later bytes depending on which type of command is being received 3) If a received command deviated from the expected format, the command is asked to be repeated

command\+Mode = 0 handles all undefined behavior command\+Mode = 1 corresponds to the G\+UI ordering the E\+CU to do something (starting or stopping) command\+Mode = 2 corresponds to the G\+UI requesting that the throttle be changed to a specified value (in percent of max)


\begin{DoxyParams}{Parameters}
{\em void} & \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
void 
\end{DoxyReturn}


Definition at line 191 of file Communication.\+c.



References assign\+\_\+bit(), command\+Mode, connect\+\_\+count, connected\+\_\+\+G\+UI, G\+U\+I\+\_\+\+Connect(), has\+Interrupted, new\+Command, repeat\+Command(), send\+To\+Laptop(), shutdown(), startup(), throttle(), and throttle\+\_\+per.


\begin{DoxyCode}
192 \{
193     \textcolor{comment}{// This will automatically clear the interrupt flag}
194     \textcolor{keywordtype}{char} data = UDR0;
195     \mbox{\hyperlink{_e_c_u__funcs_8h_ac8b367a3ec51bcbf0a598e54edda7610}{hasInterrupted}} = 1;                    \textcolor{comment}{// Set this flag so that the ESBCommand function
       knows if it has been interrupted or not}
196     \textcolor{keywordflow}{if} (\mbox{\hyperlink{_e_c_u__funcs_8h_a4a8bbdf0f587322d8d34a2d4b84ea8a6}{newCommand}})\{
197         \mbox{\hyperlink{_e_c_u__funcs_8h_a4a8bbdf0f587322d8d34a2d4b84ea8a6}{newCommand}} = 0;                    \textcolor{comment}{// reset this so that the commandMode cannot change
       until the command string is done}
198         \textcolor{keywordflow}{if} (data == \textcolor{charliteral}{'A'})\{
199             \mbox{\hyperlink{_e_c_u__funcs_8h_a04e4c743fe091014b2a959319bc508ef}{connect\_count}} = 1;
200             \mbox{\hyperlink{_e_c_u__funcs_8h_a4a8bbdf0f587322d8d34a2d4b84ea8a6}{newCommand}} = 1;
201         \}
202         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (data == \textcolor{charliteral}{'C'} && \mbox{\hyperlink{_e_c_u__funcs_8h_a04e4c743fe091014b2a959319bc508ef}{connect\_count}} == 1)\{
203             \mbox{\hyperlink{_e_c_u__funcs_8h_a04e4c743fe091014b2a959319bc508ef}{connect\_count}}++;
204             \mbox{\hyperlink{_e_c_u__funcs_8h_a4a8bbdf0f587322d8d34a2d4b84ea8a6}{newCommand}} = 1;
205         \}
206         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (data == \textcolor{charliteral}{'E'} && \mbox{\hyperlink{_e_c_u__funcs_8h_a04e4c743fe091014b2a959319bc508ef}{connect\_count}} == 2)\{
207             \mbox{\hyperlink{_e_c_u__funcs_8h_a04e4c743fe091014b2a959319bc508ef}{connect\_count}}++;
208             \mbox{\hyperlink{_e_c_u__funcs_8h_a4a8bbdf0f587322d8d34a2d4b84ea8a6}{newCommand}} = 1;
209         \}
210         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (data == \textcolor{charliteral}{'S'} && \mbox{\hyperlink{_e_c_u__funcs_8h_a04e4c743fe091014b2a959319bc508ef}{connect\_count}} == 3)\{
211             \mbox{\hyperlink{_e_c_u__funcs_8h_a04e4c743fe091014b2a959319bc508ef}{connect\_count}}++;
212             \mbox{\hyperlink{_communication_8c_ada467eaa29152bd3a35afbf4d62e53fd}{GUI\_Connect}}();
213             \mbox{\hyperlink{_e_c_u__funcs_8h_a4a8bbdf0f587322d8d34a2d4b84ea8a6}{newCommand}} = 1;
214         \}
215         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (data == \textcolor{charliteral}{'O'})\{
216             \mbox{\hyperlink{_e_c_u__funcs_8h_a543395e72464c9afc14f3766126d2d59}{commandMode}} = 1;               \textcolor{comment}{// This means the GUI is ordering the ECU to do
       something}
217         \}
218         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (data == \textcolor{charliteral}{'T'})\{
219             \mbox{\hyperlink{_e_c_u__funcs_8h_a543395e72464c9afc14f3766126d2d59}{commandMode}} = 2;               \textcolor{comment}{// This means the GUI is requesting the ECU change
       the throttle to a specified value}
220         \}
221         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (data == \textcolor{charliteral}{'K'})\{             \textcolor{comment}{// This means the GUI is sending a confirmation message for
       receiving the usual data transfer}
222             \mbox{\hyperlink{_e_c_u__funcs_8h_a4a8bbdf0f587322d8d34a2d4b84ea8a6}{newCommand}} = 1;
223             \textcolor{comment}{// stop timer 4}
224             \mbox{\hyperlink{_e_c_u__funcs_8c_aba7fa75d6dd6ebcdc6225282a798fcd2}{assign\_bit}}(&TCCR4B, CS41, 0);
225             \mbox{\hyperlink{_e_c_u__funcs_8c_aba7fa75d6dd6ebcdc6225282a798fcd2}{assign\_bit}}(&TCCR4B, CS40, 0);            \textcolor{comment}{// turn off the timer}
226             TCNT4 = 40536;                           \textcolor{comment}{// reset the timer register}
227         \}
228         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (data == \textcolor{charliteral}{'R'})\{    \textcolor{comment}{// This means that the data needs to be sent to the GUI one more time}
229             \mbox{\hyperlink{_e_c_u__funcs_8h_a4a8bbdf0f587322d8d34a2d4b84ea8a6}{newCommand}} = 1;
230             \mbox{\hyperlink{_communication_8c_aebc6f692b7c3787a859445b96ab3ec5f}{sendToLaptop}}();   \textcolor{comment}{// this will just use what ever the values of the data currently
       are}
231         \}
232         \textcolor{keywordflow}{else}\{
233             \mbox{\hyperlink{_e_c_u__funcs_8h_a543395e72464c9afc14f3766126d2d59}{commandMode}} = 0;               \textcolor{comment}{// This will handle all undefined behavior}
234             \textcolor{keywordflow}{if} (!\mbox{\hyperlink{_e_c_u__funcs_8h_aaaa9e2d2909ceb75751c9dbfab30661c}{connected\_GUI}})
235                 \mbox{\hyperlink{_e_c_u__funcs_8h_a4a8bbdf0f587322d8d34a2d4b84ea8a6}{newCommand}} = 1;     \textcolor{comment}{// This was found to work during debugging as there is a 0
       waiting in the buffer}
236         \}
237     \}
238     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{_e_c_u__funcs_8h_aaaa9e2d2909ceb75751c9dbfab30661c}{connected\_GUI}}) \{
239         \mbox{\hyperlink{_e_c_u__funcs_8h_a4a8bbdf0f587322d8d34a2d4b84ea8a6}{newCommand}} = 1;
240         \textcolor{keywordflow}{switch} (\mbox{\hyperlink{_e_c_u__funcs_8h_a543395e72464c9afc14f3766126d2d59}{commandMode}})\{
241             \textcolor{keywordflow}{case} 0:
242                 \mbox{\hyperlink{_communication_8c_a285a2f8773a070acdcea234b60cf38ca}{repeatCommand}}();           \textcolor{comment}{// repeat the command because something got screwed
       up  This isn't right because I don't do it over spi, do it over USART}
243                 \textcolor{keywordflow}{break};
244             \textcolor{keywordflow}{case} 1:
245                 \textcolor{keywordflow}{if} (data == \textcolor{charliteral}{'S'})\{          \textcolor{comment}{// GUI wants the engine to stop}
246                     \mbox{\hyperlink{_e_c_u__funcs_8h_a1c9d5e29ad8899afe0c34571ddee18f9}{shutdown}}();
247                 \}
248                 \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (data == \textcolor{charliteral}{'r'})\{     \textcolor{comment}{// GUI wants the engine to start}
249                     \mbox{\hyperlink{_e_c_u__funcs_8h_ab0c801cf89f8b3058ff2460c666154c3}{startup}}();
250                 \}
251                 \textcolor{keywordflow}{else}\{
252                     \mbox{\hyperlink{_communication_8c_a285a2f8773a070acdcea234b60cf38ca}{repeatCommand}}();       \textcolor{comment}{// undefined behavior, ask GUI to repeat}
253                 \}
254                 \textcolor{keywordflow}{break};
255             \textcolor{keywordflow}{case} 2:
256                 \mbox{\hyperlink{_e_c_u__funcs_8h_a800e7967d4d08ade3357ea12c132dd46}{throttle\_per}} = data;       \textcolor{comment}{// GUI wants the throttle to the value specified by
       data}
257                 \mbox{\hyperlink{_e_c_u__funcs_8h_a54163ad9d4f9e7fa08b4aae836a1b316}{throttle}}();
258                 \textcolor{keywordflow}{break};
259         \}
260         \mbox{\hyperlink{_e_c_u__funcs_8h_a4a8bbdf0f587322d8d34a2d4b84ea8a6}{newCommand}} = 1;                    \textcolor{comment}{// reset this so that a new command will be accepted
       in the way that is expected}
261         
262     \}
263 \}
\end{DoxyCode}
\mbox{\Hypertarget{_communication_8c_a285a2f8773a070acdcea234b60cf38ca}\label{_communication_8c_a285a2f8773a070acdcea234b60cf38ca}} 
\index{Communication.\+c@{Communication.\+c}!repeat\+Command@{repeat\+Command}}
\index{repeat\+Command@{repeat\+Command}!Communication.\+c@{Communication.\+c}}
\subsubsection{\texorpdfstring{repeat\+Command()}{repeatCommand()}}
{\footnotesize\ttfamily void repeat\+Command (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Requests the Windows G\+UI to repeat the last sent command. 

This performs the following functions\+:

1) Sends the char to the G\+UI which signals a command repetition is required


\begin{DoxyParams}{Parameters}
{\em void} & \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
void 
\end{DoxyReturn}


Definition at line 349 of file Communication.\+c.


\begin{DoxyCode}
350 \{
351     \textcolor{comment}{/* Wait for empty transmit buffer */}
352     \textcolor{keywordflow}{while} ( !( UCSR0A & (1<<UDRE0)) );
353     
354     \textcolor{comment}{/* Put data into buffer, sends the data */}
355     UDR0 = \textcolor{charliteral}{'V'}; 
356     \textcolor{comment}{// Will have to see in unit testing how long this takes to get the response from the GUI}
357 \}
\end{DoxyCode}
\mbox{\Hypertarget{_communication_8c_a9ad78c90a2e828201a614444385801c7}\label{_communication_8c_a9ad78c90a2e828201a614444385801c7}} 
\index{Communication.\+c@{Communication.\+c}!send\+To\+E\+SB@{send\+To\+E\+SB}}
\index{send\+To\+E\+SB@{send\+To\+E\+SB}!Communication.\+c@{Communication.\+c}}
\subsubsection{\texorpdfstring{send\+To\+E\+S\+B()}{sendToESB()}}
{\footnotesize\ttfamily void send\+To\+E\+SB (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{len }\end{DoxyParamCaption})}



Transmits data between the E\+CU and E\+SB. 

This performs the following functions\+:

1) Pulls the SS line for the E\+SB low, this will cause the E\+SB to listen to the com line 2) Fills the specified data into the transmit buffer 3) Waits for the data to be received from the E\+SB 4) Pulls the SS line high to end communication with E\+SB for that byte


\begin{DoxyParams}{Parameters}
{\em char} & The byte that is going to be sent to the E\+SB \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
char The received byte from the E\+SB 
\end{DoxyReturn}


Definition at line 28 of file Communication.\+c.



References E\+S\+Btransmit.


\begin{DoxyCode}
29 \{
30     \textcolor{comment}{// this will send the number of character in ESBmessage up to len}
31     cli();
32     \textcolor{keywordflow}{for}(uint8\_t i = 0; i < len; i++)
33     \{
34         \textcolor{keywordflow}{while} ( !( UCSR1A & (1<<UDRE1)) );
35         \textcolor{comment}{/* Put data into buffer, sends the data */}
36         UDR1 = \mbox{\hyperlink{_e_c_u__funcs_8h_a346573bf31cc5cb1e4a0d2d95029782a}{ESBtransmit}}[i];
37     \}
38     sei();
39 \}
\end{DoxyCode}
\mbox{\Hypertarget{_communication_8c_aebc6f692b7c3787a859445b96ab3ec5f}\label{_communication_8c_aebc6f692b7c3787a859445b96ab3ec5f}} 
\index{Communication.\+c@{Communication.\+c}!send\+To\+Laptop@{send\+To\+Laptop}}
\index{send\+To\+Laptop@{send\+To\+Laptop}!Communication.\+c@{Communication.\+c}}
\subsubsection{\texorpdfstring{send\+To\+Laptop()}{sendToLaptop()}}
{\footnotesize\ttfamily void send\+To\+Laptop (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Transmits periodic data between the E\+CU and Windows G\+UI. 

This performs the following functions\+:

1) Prepares the message to send to the Windows G\+UI 2) Loops through this message, sending it one byte at a time


\begin{DoxyParams}{Parameters}
{\em void} & \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
void 
\end{DoxyReturn}


Definition at line 96 of file Communication.\+c.



References calculate\+Parity(), connected\+\_\+\+E\+SB, E\+C\+U\+\_\+temp, E\+GT, E\+S\+B\+\_\+temp, glow\+\_\+plug, Hall\+\_\+effect, mass\+Flow, op\+Mode, and voltage.


\begin{DoxyCode}
97 \{
98     \textcolor{comment}{//loadESBData();}
99     dummyData();    \textcolor{comment}{// remove this later}
100     \textcolor{comment}{// This function will be responsible for packaging and sending the desired data to the Windows GUI}
101     \textcolor{keywordtype}{char} message[28];              \textcolor{comment}{// this is the base length of the message with room for the parity bytes}
102     \textcolor{comment}{// now fill the message}
103     \textcolor{keywordflow}{if} (!\mbox{\hyperlink{_e_c_u__funcs_8h_a20d5783317799eb3e211c4cae2516cec}{connected\_ESB}})\{
104         message[0] = \textcolor{charliteral}{'b'};          \textcolor{comment}{// This means that the ESB is not connected or it has lost connection}
105     \}
106     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{_e_c_u__funcs_8h_ab1fa4bbd357586cbfa309f1b8614c1ae}{opMode}} == 0)\{
107         message[0] = \textcolor{charliteral}{'S'};          \textcolor{comment}{// This means that an engine shutdown is being carried out}
108     \}
109     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\mbox{\hyperlink{_e_c_u__funcs_8h_ab1fa4bbd357586cbfa309f1b8614c1ae}{opMode}} == 1)\{
110         message[0] = \textcolor{charliteral}{'r'};          \textcolor{comment}{// This means that an engine startup is in progress}
111     \}
112     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\mbox{\hyperlink{_e_c_u__funcs_8h_ab1fa4bbd357586cbfa309f1b8614c1ae}{opMode}} == 2)\{
113         message[0] = \textcolor{charliteral}{'t'};          \textcolor{comment}{// This means that a throttle adjustment has been requested and is being
       carried out}
114     \}
115     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\mbox{\hyperlink{_e_c_u__funcs_8h_ab1fa4bbd357586cbfa309f1b8614c1ae}{opMode}} == 4)\{
116         message[0] = \textcolor{charliteral}{'C'};          \textcolor{comment}{// This means that the engine is in the cooling mode}
117     \}
118     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\mbox{\hyperlink{_e_c_u__funcs_8h_ab1fa4bbd357586cbfa309f1b8614c1ae}{opMode}} == 5)\{
119         message[0] = \textcolor{charliteral}{'n'};          \textcolor{comment}{// The engine is not doing anything}
120     \}
121     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{_e_c_u__funcs_8h_ab1fa4bbd357586cbfa309f1b8614c1ae}{opMode}} == 6)\{
122         message[0] = \textcolor{charliteral}{'g'};          \textcolor{comment}{// Special shutdown, the EGT is not working properly and there cannot be
       a normal cooling mode}
123     \}
124     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{_e_c_u__funcs_8h_ab1fa4bbd357586cbfa309f1b8614c1ae}{opMode}} == 7)\{
125         message[0] = \textcolor{charliteral}{'N'};          \textcolor{comment}{// This means that the engine has reached the desired throttle, within
       the error tolerance}
126     \}
127     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{_e_c_u__funcs_8h_ab1fa4bbd357586cbfa309f1b8614c1ae}{opMode}} == 9)\{         \textcolor{comment}{// This means that fuel is not flowing when it should be flowing}
128         message[0] = \textcolor{charliteral}{'P'};   
129     \}
130     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{_e_c_u__funcs_8h_ab1fa4bbd357586cbfa309f1b8614c1ae}{opMode}} == 10)\{
131         message[0] = \textcolor{charliteral}{'I'};          \textcolor{comment}{// This means that the engine has reached idle}
132     \}
133     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{_e_c_u__funcs_8h_ab1fa4bbd357586cbfa309f1b8614c1ae}{opMode}} == 11)\{
134         message[0] = \textcolor{charliteral}{'c'};          \textcolor{comment}{// This means that messages from the ECU have failed the parity check}
135     \}
136     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{_e_c_u__funcs_8h_ab1fa4bbd357586cbfa309f1b8614c1ae}{opMode}} == 12)\{
137         message[0] = \textcolor{charliteral}{'R'};          \textcolor{comment}{// This means that RPM limit has been reached and the engine is shutting
       down}
138     \}
139     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{_e_c_u__funcs_8h_ab1fa4bbd357586cbfa309f1b8614c1ae}{opMode}} == 13)\{
140         message[0] = \textcolor{charliteral}{'T'};          \textcolor{comment}{// This means the Temperature limit has been reached and the engine is
       shutting down}
141     \}
142     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{_e_c_u__funcs_8h_ab1fa4bbd357586cbfa309f1b8614c1ae}{opMode}} == 14)\{
143         message[0] = \textcolor{charliteral}{'s'};          \textcolor{comment}{// This means that messages from the ESB have failed the parity check}
144     \}
145         
146     memcpy(message+1,&\mbox{\hyperlink{_e_c_u__funcs_8h_a411b8ca204ac2d44a3755adcf4477c92}{massFlow}},\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float}));          \textcolor{comment}{// This should fill 1->4 with the float
       value}
147     memcpy(message+5,&\mbox{\hyperlink{_e_c_u__funcs_8h_afc4ac50caf210854dacff228ba315687}{Hall\_effect}},\textcolor{keyword}{sizeof}(uint16\_t));    \textcolor{comment}{// This should fill 5->6 with the Hall
       effect sensor value}
148     memcpy(message+7,&\mbox{\hyperlink{_e_c_u__funcs_8h_a34c104e39ff60265f33e3325bf865ab5}{EGT}},\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float}));            \textcolor{comment}{// This should fill 7->8 with the EGT value }
149     memcpy(message+11,&\mbox{\hyperlink{_e_c_u__funcs_8h_ad849b9fe0e266552696acb467ff745f7}{voltage}},\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float}));      \textcolor{comment}{// this should fill 9->12 with the value of the
       battery voltage}
150     memcpy(message+15,&\mbox{\hyperlink{_e_c_u__funcs_8h_a17961c0bba1aa12ef80b5b9b78726530}{glow\_plug}},\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}));         \textcolor{comment}{// This should fill 13 with the glow plug
       on/off}
151     memcpy(message+16,&\mbox{\hyperlink{_e_c_u__funcs_8h_ad0434de2efd3a26ea1211a9cec967577}{ECU\_temp}},\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float}));         \textcolor{comment}{// This should fill 14->17 with the
       temperature of the ECU}
152     memcpy(message+20,&\mbox{\hyperlink{_e_c_u__funcs_8h_a359dd774222ff15507f3efb2d0e89bbe}{ESB\_temp}},\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float}));         \textcolor{comment}{// This should fill 18->21 with the ambient
       temperature of the ESB}
153     
154     \textcolor{comment}{// now that the message is made, I need to calculate and populate the parity bytes}
155     message[24] = \mbox{\hyperlink{_e_c_u__funcs_8c_adc85b180d655324bb96dcb29cff05af3}{calculateParity}}(message, 0);
156     message[25] = \mbox{\hyperlink{_e_c_u__funcs_8c_adc85b180d655324bb96dcb29cff05af3}{calculateParity}}(message, 6);
157     message[26] = \mbox{\hyperlink{_e_c_u__funcs_8c_adc85b180d655324bb96dcb29cff05af3}{calculateParity}}(message, 12);
158     message[27] = \mbox{\hyperlink{_e_c_u__funcs_8c_adc85b180d655324bb96dcb29cff05af3}{calculateParity}}(message, 18);
159     
160     \textcolor{comment}{// At this point it is advantageous to turn off global interrupts so that this process is not
       interrupted}
161     cli();
162     \textcolor{keywordflow}{for} (uint8\_t i = 0; i < 28; i++)\{
163         \textcolor{comment}{/* Wait for empty transmit buffer */}
164         \textcolor{keywordflow}{while} ( !( UCSR0A & (1<<UDRE0)) );
165         \textcolor{comment}{/* Put data into buffer, sends the data */}
166         UDR0 = message[i];
167     \}
168     sei();   \textcolor{comment}{// Now need to turn global interrupts back on}
169     \textcolor{comment}{// Now start the timer}
170     
171     TCCR4B = (1 << CS42);      \textcolor{comment}{// start timer 4 with prescalar of 256}
172 
173 
174 \}
\end{DoxyCode}
